---
title: 如何以 SRE 角度改善既有系統
description: "July 20, 2019"
layout: default_zh
---

![cover](Improve-Legacy-System-from-SRE-Perspective/cover.png)

要改善既有系統（Legacy System）一直以來都不是一件容易的事情，尤其是當面臨要改動整體架構時，需要耗費的時間和人力成本往往讓老闆無法輕易買單。因此，如何評估既有系統並明確指出為什麼要進行改善，以及新的系統架構要如何設計才能面對更大的挑戰，是非常重要的。本篇文章將以 [SRE 課程](https://www.coursera.org/learn/site-reliability-engineering-slos/) 中的評估方法作為主軸進行系統評估，結合 [從零開始學架構](https://www.tenlong.com.tw/products/9787121347917) 和 [大規模數據處理實戰](https://time.geekbang.org/column/intro/167) 兩本書中的知識，總結出一套通用且不會過於複雜的系統改善技巧。

## 大綱

* [學習案例介紹](#學習案例介紹)
    - [案例：轉轉咖啡屋](#案例：轉轉咖啡屋)
    - [從單體到微服務](#從單體到微服務)
    - [新的挑戰：更大的規模](#新的挑戰：更大的規模)
* [系統評估](#系統評估)
    - 標示出現有系統的數據流，工作流
    - 標示批處理，流處理
    - 標示 SLI Menu，Request / Response or Data Processing or Data Store
* 系統改善設計

## 學習案例介紹

[從零開始學架構](https://www.tenlong.com.tw/products/9787121347917) 中提到的架構設計三原則：合適、簡單、演化。你不需要在一開始就設計一個技術領先於業界的系統，正所謂『將軍難打無兵之仗』，一開始就投入大量的人力與時間在開發一個高可用、高乘載的系統卻沒有半個使用者，是一點意義也沒有的。所以，設計不良的舊有系統（Legacy System）存在於成功的企業中是常見、正常的狀況。畢竟往往正是因為有了這些符合成本且滿足初期使用者需求的舊有系統，才成就了所謂的成功企業。

### 案例：轉轉咖啡屋

轉轉咖啡屋是一個虛擬的咖啡廳開店平台，提供每一個註冊店家可以在轉轉咖啡屋上開一家屬於自己的咖啡店，並有咖啡配送員幫你將新鮮的咖啡送給消費者。一開始，轉轉咖啡屋做了一個簡單的網站，消費者端有瀏覽店家、咖啡菜單查詢、下單購買、搜尋所有店家菜單等功能。店家端有更新菜單、通知配送員等功能。這個網站使用了單體 + RDBMS 的架構做成如下圖示。過沒多久，轉轉咖啡屋使用者人數一飛沖天，店家數也即將破百。由於搜尋所有店家菜單功能依賴 SQL 查詢關聯式資料庫，效率十分低落，隨著每秒查詢量增加，不但搜尋的速度變慢，還造成 RDBMS 過載，連帶影響到其他功能。

### 從單體到微服務

轉轉咖啡屋唯一的工程師在時間壓力下，決定先將搜尋所有店家菜單功能獨立出來，做成第一個微服務，並使用 [ElasticSearch](https://www.elastic.co/products/elasticsearch) 作為搜尋引擎，改善搜尋效率，並寫了一隻同步程式，每分鐘會將更新資料從 RDB 同步到 ElasticSearch。

### 新的挑戰：更大的規模

在拆分咖啡搜尋服務之後，解決了搜尋效率問題以及降低了搜尋功能與主要功能之間互相影響的程度。當每秒搜尋次數增加時，也可以單獨的擴充咖啡搜尋服務來應付。

一年過去了，轉轉咖啡屋的店家數量破萬，使用者人數更不用說。由於穩定獲利，轉轉咖啡屋聘請了更多的工程師，也成立了獨立的 SRE 團隊。

此時，咖啡搜尋服務開始出現了一些客戶抱怨，例如：

- 已經下架的咖啡出現在搜尋結果當中。
- 搜尋出現的咖啡價格與實際販售的不一致。

原來，由於個人咖啡店的特色是每個人都可以少量販售，隨時修改咖啡菜單和可販售數量。然而資料是由 RDB 經由中間程式同步到 ElasticSearch 的，隨著店家數量變多，資料量變大，中間同步的時間也漸漸地不斷拉長，導致搜尋結果資訊落差。這些資訊落差，已經嚴重的影響到消費者體驗了。

對於轉轉咖啡屋的 SRE 團隊來說，咖啡搜尋服務這個既有系統，該如何去分析並解決這個問題呢？

## 系統評估

好的，接下來終於可以進入我們今天的主題了，